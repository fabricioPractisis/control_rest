<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<script src="js/jquery.js"></script>
		<script src="js/index.js"></script>
		<script src="js/jquery-ui.min.js"></script>
		<script src="js/bootstrap.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<link rel="stylesheet" type="text/css" href="css/bootstrap.css" /> 
		<link rel="stylesheet" type="text/css" href="css/bootstrap-theme.css" />
	</head>
	<body onload = "$('#username').focus();">
		<div class="row" style="background-color:#1B5583;">
					<div class="col-lg-12" style="text-align:center; vertical-align:middle;">
						<center><img src="img/logo1.png" style="width:50px" /></center>
					</div>
				</div>
		<div id="login">
			<div style="border:2px solid #1B5583; padding-bottom:20px;">
				<div class="row" style="margin-top:50px;">
					<div class="col-lg-12">
						<div class="input-group">
							<span class="input-group-addon" id="basic-addon1">
								<span class="glyphicon glyphicon-cog" aria-hidden="true"></span>
							</span>
							<input type="text" class="form-control" placeholder="ingrese usuario" aria-describedby="basic-addon1" id="username" />
						</div>
					</div>
				</div>
				<div class="row" style="margin-top:25px;">
					<div class="col-lg-12">
						<div class="input-group">
							<span class="input-group-addon" id="basic-addon1">
								<span class="glyphicon glyphicon-oil" aria-hidden="true"></span>
							</span>
							<input type="password" class="form-control" placeholder="***********" aria-describedby="basic-addon1" id="pass" />
							
						</div>
					</div>
				</div>
				<div class="row" style="margin-top:25px; text-align:center;" id="botones">
					<div class="col-lg-12" style="vertical-align:middle;">
						
						<button class="btn btn-primary" type="button" id = 'sin_loguear' style = 'display:none;' onclick="valida_log_acceso()">
							Ingresar
							<img src = 'img/loading.gif' style = 'display:none;width:20px;' id = 'loadLogin'/>
						</button>
						<button class="btn btn-success" type="button" id = 'ya_logueado' onclick="valida_log_acceso_conSesion()" >Ingresar</button>
					</div>
				</div>
				<div class="row" style="margin-top:25px; display:none;" id="loading">
					<div class="col-lg-12" style="text-align:center; vertical-align:middle;">
						<img src="img/loading.gif" style="max-width:70px;" />
						<h4>Ingresando al Sistema...</h4>
					</div>
				</div>
			</div>
			<div class="modal fade" id="alerta" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header" style="background-color:#C51D34; color:#fff;">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
							<h4 class="modal-title" id="myModalLabel">Alerta!</h4>
						</div>
						<div class="modal-body">
							<div class="alert alert-warning" role="alert">
								<span class="glyphicon glyphicon-warning-sign" aria-hidden="true"></span>&nbsp;
								<strong>Alerta! </strong>Los datos ingresados son incorrectos.
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-primary" data-dismiss="modal">Aceptar</button>
						</div>
					</div>
				</div>
			</div>
			<div id="boletos" style="display:block;"></div>
		</div>
		<script>
			ver_sesiones(); 
			function ver_sesiones(){
				var db = window.openDatabase("Database", "1.0", "TicketMobile", 200000);
				db.transaction(function(tx){
					tx.executeSql('SELECT * FROM usu_empresas',[],function(tx,results){
						var registros = results.rows.length;
						if(registros == 0){
							//alert('no hay');
							$('#sin_loguear').fadeIn('slow');
							$('#ya_logueado').css('display','none');
						}else{
							//alert('si hay');
							$('#sin_loguear').css('display','none');
							$('#ya_logueado').fadeIn('slow');
						}
					},errorCB,successCB);
				});
			}
			function valida_log_acceso_conSesion(){
				window.location = 'index.html';
			}
			function valida_log_acceso(){
				var username = $('#username').val();
				var pass = $('#pass').val();
				
				if(username == ''){
					alert('ingrese su usuario');
				}
				
				if(pass == ''){
					alert('ingrese password');
				}
				
				if(username == '' || pass == ''){
					
				}else{
					var ruta = 'http://www.lcodigo.com/ticket/apiMovil/baja_empresas.php';
					$('#loadLogin').css('display','block');
					alert(ruta);
					$.post(ruta,{ 
						pass : pass , username : username
					}).done(function(data){
						alert(data);
						if($.trim(data)=='error'){
							alert('no hay datos para ese evento : ' + id_con)
						}else{
							if($.trim(data)=='vacio'){
								alert('su clave ingresada es incorrecta !!!');
								window.location = '';
							}else{
							
							
								var res = data.split("|"); 
										//alert(res[1]);
								var objDatos=JSON.parse(res[0]);
								var locales=objDatos.Empresas;
								//alert(locales.length);
								var db = window.openDatabase("Database", "1.0", "TicketMobile", 200000);
								db.transaction(function(tx){
									for(i=0; i < locales.length; i++){
										var id = locales[i].id; 
										var nombre = locales[i].nombre; 
										var usuario = locales[i].usuario; 
										var pass = locales[i].pass; 
										//alert('id : ' + id + '  nombre : ' + nombre +  ' usuario : ' +  usuario + ' pass : ' + pass );
										tx.executeSql("INSERT OR IGNORE INTO usu_empresas (nombre , usu , pass) VALUES (?,?,?)",[nombre,usuario,pass]);
									
										tx.executeSql('UPDATE usu_empresas SET nombre = ?,usu = ? , pass = ? WHERE id = ?;',[nombre,usuario,pass,id]);
										
									}
								},errorCB,successCB);
								$('#loadLogin').css('display','none');
								//alert("acceso correcto.");
								setTimeout(function(){
									var db = window.openDatabase("Database", "1.0", "TicketMobile", 200000);
									db.transaction(function(tx){
										tx.executeSql('SELECT * FROM usu_empresas',[],function(tx,results){
											var registros = results.rows.length;
											if(registros == 0){
												
											}else{
												window.location='index.html';
											}
										},errorCB,successCB);
									});
								}, 2000);
							}
						}
					});
				}
			}
		</script>
	</body>
</html>
